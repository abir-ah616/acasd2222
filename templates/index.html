<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MR OPPY | Command Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        :root {
            --primary: #b026ff;
            --primary-glow: rgba(176, 38, 255, 0.6);
            --secondary: #00d4ff;
            --secondary-glow: rgba(0, 212, 255, 0.6);
            --danger: #ff2a6d;
            --success: #05d5aa;
            --bg-deep: #050505;
            --glass-bg: rgba(15, 15, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-dim: #8a8a9b;
            --font-display: 'Space Grotesk', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-display);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(176, 38, 255, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 40%);
            background-attachment: fixed;
        }

        /* Animated Mesh Background */
        .bg-mesh {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- Header & Nav --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--glass-border);
            animation: slideDown 0.8s ease-out;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        h1 {
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 1.8rem;
            letter-spacing: -1px;
            background: linear-gradient(90deg, #fff, var(--text-dim));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }

        .nav-header {
            display: flex;
            gap: 10px;
            background: rgba(255,255,255,0.03);
            padding: 5px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .nav-btn {
            text-decoration: none;
            color: var(--text-dim);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-btn:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

        .nav-btn.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 0 15px var(--primary-glow);
        }

        /* --- Layout Grid --- */
        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 25px;
            flex: 1;
            min-height: 0; /* Crucial for nested scrolling */
            animation: fadeIn 1s ease-out 0.3s backwards;
        }

        .main-column {
            display: flex;
            flex-direction: column;
            gap: 25px;
            min-height: 0;
        }

        .sidebar-column {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* --- Glass Cards --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.12);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .card-title {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i { color: var(--text-dim); }

        /* --- Inputs --- */
        .input-group {
            margin-bottom: 20px;
            position: relative;
        }

        .input-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 8px;
            display: block;
            font-weight: 600;
        }

        .cyber-input-wrapper {
            position: relative;
        }

        .cyber-input {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            color: #fff;
            padding: 14px 16px;
            border-radius: 12px;
            font-family: var(--font-mono);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .cyber-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(176, 38, 255, 0.2);
            background: rgba(0,0,0,0.5);
        }

        /* --- Buttons --- */
        .btn {
            cursor: pointer;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }

        .btn:hover::before { left: 100%; }
        .btn:active { transform: scale(0.97); }

        .btn-primary {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 4px 15px rgba(176, 38, 255, 0.3);
        }
        .btn-primary:hover { box-shadow: 0 6px 20px rgba(176, 38, 255, 0.5); }

        .btn-secondary {
            background: rgba(255,255,255,0.05);
            color: #fff;
            border: 1px solid var(--glass-border);
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); border-color: #fff; }

        .btn-danger {
            background: rgba(255, 42, 109, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 42, 109, 0.3);
        }
        .btn-danger:hover { background: var(--danger); color: #fff; box-shadow: 0 4px 15px rgba(255, 42, 109, 0.4); }

        .btn-success {
            background: linear-gradient(135deg, #05d5aa, #00b38f);
            color: #000;
            box-shadow: 0 4px 15px rgba(5, 213, 170, 0.3);
        }

        .btn-icon {
            padding: 8px;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            color: var(--text-dim);
            transition: 0.2s;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.15); color: #fff; transform: translateY(-2px); }

        /* --- UID Target List --- */
        #uid-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            max-height: 300px;
            padding-right: 5px;
        }

        #uid-container::-webkit-scrollbar { width: 4px; }
        #uid-container::-webkit-scrollbar-track { background: transparent; }
        #uid-container::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 10px; }

        .uid-row {
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            padding: 12px;
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            align-items: center;
            gap: 15px;
            border: 1px solid transparent;
            transition: 0.3s;
            animation: slideInRight 0.3s ease-out forwards;
        }

        .uid-row:hover {
            border-color: var(--primary);
            background: rgba(176, 38, 255, 0.05);
        }

        .checkbox-wrapper input {
            accent-color: var(--primary);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .emote-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-dim);
            background: rgba(255,255,255,0.03);
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
        }

        .emote-status img {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            object-fit: contain;
        }

        .emote-status.active {
            color: var(--secondary);
            border-color: rgba(0, 212, 255, 0.3);
            background: rgba(0, 212, 255, 0.05);
        }

        .row-actions { display: flex; gap: 5px; }

        /* --- Emote Grid --- */
        .emote-wrapper {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            padding-right: 5px;
        }
        .emote-wrapper::-webkit-scrollbar { width: 4px; }
        .emote-wrapper::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 10px; }

        .emote-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .emote-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }

        .emote-card:hover {
            transform: translateY(-5px) scale(1.02);
            background: rgba(255,255,255,0.07);
            border-color: rgba(255,255,255,0.2);
        }

        .emote-card.selected {
            border-color: var(--secondary);
            background: rgba(0, 212, 255, 0.08);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.15);
        }

        .emote-card.selected::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 8px; right: 8px;
            color: var(--secondary);
            font-size: 12px;
        }

        .emote-card img {
            width: 100%;
            height: 80px;
            object-fit: contain;
            margin-bottom: 10px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
            transition: transform 0.3s;
        }

        .emote-card:hover img { transform: scale(1.1); }

        .emote-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .emote-id-badge {
            font-size: 0.65rem;
            color: var(--text-dim);
            font-family: var(--font-mono);
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }
        
        /* Hidden data for JS */
        .emote-id-hidden { display: none; }

        /* --- Sidebar Stats --- */
        .stat-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255,255,255,0.02);
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            transition: 0.3s;
        }

        .stat-box:hover {
            border-color: var(--glass-border);
            background: rgba(255,255,255,0.04);
        }

        .stat-label { font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; }
        .stat-value { font-family: var(--font-mono); font-weight: 700; color: #fff; font-size: 1.1rem; }
        .stat-value.highlight { color: var(--primary); text-shadow: 0 0 10px rgba(176, 38, 255, 0.4); }

        /* --- Toast Notification --- */
        #toast-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            pointer-events: auto;
            min-width: 300px;
            background: rgba(10, 10, 12, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-left: 4px solid var(--primary);
            padding: 16px 20px;
            border-radius: 8px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .toast.success { border-left-color: var(--success); }
        .toast.danger { border-left-color: var(--danger); }
        .toast.warning { border-left-color: #ffbe0b; }

        .toast-icon { font-size: 1.2rem; }
        .success .toast-icon { color: var(--success); }
        .danger .toast-icon { color: var(--danger); }
        
        .toast-close {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .toast-progress {
            position: absolute;
            bottom: 0; left: 0;
            height: 2px;
            background: rgba(255,255,255,0.2);
            width: 100%;
            animation: shrink 4s linear forwards;
        }

        /* Animations */
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes shrink { from { width: 100%; } to { width: 0%; } }
        .fade-out { opacity: 0; transform: translateX(50px); transition: 0.4s; }

        /* Responsive */
        @media (max-width: 1024px) {
            .grid-layout { grid-template-columns: 1fr; }
            .sidebar-column { order: -1; display: grid; grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 768px) {
            .nav-header { display: none; } /* Hide top nav on mobile, maybe move to burger if needed */
            .sidebar-column { display: flex; flex-direction: column; }
            .container { padding: 10px; height: auto; }
            h1 { font-size: 1.4rem; }
            header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .nav-header { display: flex; width: 100%; overflow-x: auto; }
            .emote-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="bg-mesh"></div>
    <div id="toast-container"></div>

    <div class="container">
        <header>
            <div class="brand">
                <i class="fa-solid fa-robot fa-2x" style="color: var(--primary);"></i>
                <div>
                    <h1>Mr Oppy</h1>
                    <p style="color: var(--text-dim); font-size: 0.8rem; letter-spacing: 1px;">EMOTE COMMAND PROTOCOL</p>
                </div>
            </div>
            <nav class="nav-header">
                <a href="/" class="nav-btn active"><i class="fa-solid fa-gamepad"></i> Bot</a>
                <a href="/check" class="nav-btn"><i class="fa-solid fa-shield-halved"></i> Check Ban</a>
                <a href="/invite" class="nav-btn"><i class="fa-solid fa-user-plus"></i> Invite</a>
                <a href="/sm" class="nav-btn"><i class="fa-solid fa-rocket"></i> Spam</a>
                <a href="/attack" class="nav-btn" style="color: var(--danger);"><i class="fa-solid fa-skull"></i> Attack</a>
            </nav>
        </header>

        <!-- Flash Messages Logic Preserved -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <script>
                    window.flashMessages = {{ messages|tojson }};
                </script>
            {% endif %}
        {% endwith %}

        <form id="main-form" action="/action" method="post" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
            <input type="hidden" name="action" id="form_action">
            <input type="hidden" name="payload" id="form_payload">

            <div class="grid-layout">
                <!-- Main Panel -->
                <div class="main-column">
                    <!-- Target List -->
                    <div class="glass-card" style="flex-shrink: 0;">
                        <div class="card-header">
                            <div class="card-title"><i class="fa-solid fa-crosshairs"></i> Target Management</div>
                            <button type="button" id="add-uid-btn" class="btn btn-success" style="font-size: 0.7rem; padding: 8px 16px;">
                                <i class="fa-solid fa-plus"></i> Add Target
                            </button>
                        </div>
                        <div id="uid-container">
                            <!-- Dynamic Rows inserted here via JS -->
                        </div>
                    </div>

                    <!-- Emote Palette -->
                    <div class="glass-card" style="flex: 1; min-height: 400px;">
                        <div class="card-header">
                            <div class="card-title"><i class="fa-solid fa-icons"></i> Emote Palette</div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" id="send-selected" class="btn btn-primary">
                                    <i class="fa-solid fa-paper-plane"></i> Send Selected
                                </button>
                                <button type="button" id="send-all" class="btn btn-secondary">
                                    <i class="fa-solid fa-layer-group"></i> Send All
                                </button>
                            </div>
                        </div>
                        <div class="emote-wrapper">
                            <div class="emote-grid" id="emote-grid">
                                <!-- Static Jinja Template Items -->
                                <div class="emote-card emote-item">
                                    <img src="{{ url_for('static', filename='images/909000075.png') }}" loading="lazy" alt="MP40 MAX">
                                    <div class="emote-name">MP40 MAX</div>
                                    <div class="emote-id-badge">ID: 909000075</div>
                                    <div class="emote-id-hidden">909000075</div>
                                </div>
                                
                                <div class="emote-card emote-item">
                                    <img src="{{ url_for('static', filename='images/909000063.png') }}" loading="lazy" alt="AK47 MAX">
                                    <div class="emote-name">AK47 MAX</div>
                                    <div class="emote-id-badge">ID: 909000063</div>
                                    <div class="emote-id-hidden">909000063</div>
                                </div>
                                
                                <div class="emote-card emote-item">
                                    <img src="{{ url_for('static', filename='images/909035007.png') }}" loading="lazy" alt="M1887 MAX">
                                    <div class="emote-name">M1887 MAX</div>
                                    <div class="emote-id-badge">ID: 909035007</div>
                                    <div class="emote-id-hidden">909035007</div>
                                </div>
                                <!-- End Static Items -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="sidebar-column">
                    <!-- Settings -->
                    <div class="glass-card">
                        <div class="card-header">
                            <div class="card-title"><i class="fa-solid fa-sliders"></i> Configuration</div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Main Account UID</label>
                            <div class="cyber-input-wrapper">
                                <input type="number" id="main_player_uid" class="cyber-input" placeholder="123456789">
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Team Code</label>
                            <div class="cyber-input-wrapper">
                                <input type="text" id="team_code" class="cyber-input" placeholder="Enter Code">
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="glass-card">
                        <div class="card-header">
                            <div class="card-title"><i class="fa-solid fa-bolt"></i> Quick Actions</div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <button type="button" id="join-squad" class="btn btn-secondary">
                                <i class="fa-solid fa-right-to-bracket"></i> Join Squad
                            </button>
                            <button type="button" id="quick-invite" class="btn btn-success" style="color: #000;">
                                <i class="fa-solid fa-envelope-open-text"></i> Create & Invite
                            </button>
                            <button type="button" id="leave-squad" class="btn btn-danger">
                                <i class="fa-solid fa-right-from-bracket"></i> Leave Squad
                            </button>
                        </div>
                    </div>

                    <!-- Status HUD -->
                    <div class="glass-card">
                        <div class="card-header">
                            <div class="card-title"><i class="fa-solid fa-chart-simple"></i> Status HUD</div>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Active Targets</span>
                            <span class="stat-value" id="stat-targets">0</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Emotes Assigned</span>
                            <span class="stat-value highlight" id="stat-assigned">0</span>
                        </div>
                        <div class="stat-box" style="flex-direction: column; align-items: flex-start; gap: 5px;">
                            <span class="stat-label">Selected Emote</span>
                            <span class="stat-value" id="stat-selected" style="font-size: 0.9rem; color: var(--secondary);">None</span>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        /**
         * JS Logic Preserved from Original File
         * Adapted strictly to map to new CSS classes while keeping IDs intact.
         */
        document.addEventListener('DOMContentLoaded', () => {
            const state = { selectedEmote: null };
            const els = {
                mainUid: document.getElementById('main_player_uid'),
                teamCode: document.getElementById('team_code'),
                uidContainer: document.getElementById('uid-container'),
                emoteGrid: document.getElementById('emote-grid'),
                form: document.getElementById('main-form'),
                formAction: document.getElementById('form_action'),
                formPayload: document.getElementById('form_payload')
            };

            function updateStats() {
                const rows = els.uidContainer.querySelectorAll('.uid-row');
                const assigned = Array.from(rows).filter(r => r.dataset.emoteId).length;
                document.getElementById('stat-targets').textContent = rows.length;
                document.getElementById('stat-assigned').textContent = assigned;
                document.getElementById('stat-selected').textContent = state.selectedEmote ? state.selectedEmote.name : 'None';
            }

            function updateEmoteBadge(row, emoteData) {
                const badge = row.querySelector('.emote-status');
                if (emoteData && emoteData.id) {
                    row.dataset.emoteId = emoteData.id;
                    row.dataset.emoteName = emoteData.name;
                    row.dataset.emoteImg = emoteData.img;
                    
                    badge.classList.add('active');
                    const img = badge.querySelector('img');
                    img.src = emoteData.img;
                    img.style.display = 'block';
                    badge.querySelector('span').textContent = emoteData.name;
                } else {
                    delete row.dataset.emoteId;
                    delete row.dataset.emoteName;
                    delete row.dataset.emoteImg;
                    
                    badge.classList.remove('active');
                    badge.querySelector('img').style.display = 'none';
                    badge.querySelector('span').textContent = 'No Emote';
                }
            }

            function createUidRow(targetData = {}, isMain = false) {
                const div = document.createElement('div');
                div.className = 'uid-row';
                // Using cyber-input class structure
                div.innerHTML = `
                    <div class="checkbox-wrapper">
                        <input type="checkbox" checked>
                    </div>
                    <input type="number" class="cyber-input" placeholder="${isMain ? 'Main UID (You)' : 'Target UID'}" value="${targetData.uid || ''}" ${isMain ? 'readonly style="opacity:0.7"' : ''}>
                    
                    <div class="emote-status">
                        <img src="" style="display:none">
                        <span>No Emote</span>
                    </div>
                    
                    <div class="row-actions">
                        <button type="button" class="btn-icon" title="Assign Selected Emote" data-action="assign"><i class="fa-solid fa-thumbtack"></i></button>
                        <button type="button" class="btn-icon" title="Clear Emote" data-action="clear" style="color: var(--text-dim)"><i class="fa-solid fa-eraser"></i></button>
                        <button type="button" class="btn-icon" title="Send Individual" data-action="send" style="color: var(--secondary)"><i class="fa-solid fa-paper-plane"></i></button>
                        ${!isMain ? '<button type="button" class="btn-icon" title="Remove Row" data-action="remove" style="color: var(--danger)"><i class="fa-solid fa-trash"></i></button>' : ''}
                    </div>`;
                els.uidContainer.appendChild(div);
                
                if (targetData.emoteId) {
                    updateEmoteBadge(div, { id: targetData.emoteId, name: targetData.emoteName, img: targetData.emoteImg });
                }
                updateStats();
                return div;
            }

            function saveData() {
                localStorage.setItem('spideerio_main_uid', els.mainUid.value);
                localStorage.setItem('spideerio_team_code', els.teamCode.value);
                const targets = [];
                els.uidContainer.querySelectorAll('.uid-row').forEach(row => {
                    const uidInput = row.querySelector('input[type="number"]');
                    // Skip if no input found
                    if(!uidInput) return;

                    const target = { uid: uidInput.value };
                    if (row.dataset.emoteId) {
                        target.emoteId = row.dataset.emoteId;
                        target.emoteName = row.dataset.emoteName;
                        target.emoteImg = row.dataset.emoteImg;
                    }
                    if (uidInput.readOnly) target.isMain = true;
                    targets.push(target);
                });
                localStorage.setItem('spideerio_targets', JSON.stringify(targets));
            }

            function loadData() {
                els.mainUid.value = localStorage.getItem('spideerio_main_uid') || '';
                els.teamCode.value = localStorage.getItem('spideerio_team_code') || '';
                const targets = JSON.parse(localStorage.getItem('spideerio_targets') || '[]');
                els.uidContainer.innerHTML = '';
                if (targets.length === 0) createUidRow({ uid: els.mainUid.value }, true);
                else targets.forEach(t => createUidRow(t, t.isMain));
                updateStats();
            }

            function submitForm(action, payload) {
                els.formAction.value = action;
                els.formPayload.value = JSON.stringify(payload);
                els.form.submit();
            }

            els.mainUid.addEventListener('input', () => {
                const mainRowInput = els.uidContainer.querySelector('.uid-row input[readonly]');
                if (mainRowInput) mainRowInput.value = els.mainUid.value;
                saveData();
            });

            els.teamCode.addEventListener('input', saveData);

            document.getElementById('add-uid-btn').addEventListener('click', () => {
                if (els.uidContainer.children.length >= 8) { // Increased limit slightly for better UX
                    showToast('Maximum 8 targets allowed', 'warning');
                    return;
                }
                createUidRow({}, false);
            });

            // Emote Selection Logic
            els.emoteGrid.addEventListener('click', e => {
                const card = e.target.closest('.emote-item');
                if (!card) return;
                
                const name = card.querySelector('.emote-name').textContent;
                // Adjusted selector for new structure
                const idText = card.querySelector('.emote-id-hidden').textContent.trim();
                const img = card.querySelector('img').src;
                
                state.selectedEmote = { id: idText, name: name, img: img };
                
                els.emoteGrid.querySelectorAll('.emote-item').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                updateStats();
            });

            els.uidContainer.addEventListener('input', e => {
                if (e.target.matches('input[type="number"]')) saveData();
            });

            els.uidContainer.addEventListener('click', e => {
                const btn = e.target.closest('button[data-action]');
                if (!btn) return;
                
                const row = btn.closest('.uid-row');
                const action = btn.dataset.action;
                
                if (action === 'assign') {
                    if (!state.selectedEmote) {
                        showToast('Select an emote from the palette first', 'warning');
                        return;
                    }
                    updateEmoteBadge(row, state.selectedEmote);
                } else if (action === 'clear') {
                    updateEmoteBadge(row, null);
                } else if (action === 'send') {
                    const uid = row.querySelector('input[type="number"]').value;
                    const emoteId = row.dataset.emoteId;
                    if (!uid || !emoteId) {
                        showToast('UID required and emote must be assigned', 'danger');
                        return;
                    }
                    submitForm('emote_batch', [{ player_id: parseInt(uid), emote_id: parseInt(emoteId) }]);
                } else if (action === 'remove') {
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        row.remove();
                        saveData();
                        updateStats();
                    }, 300);
                    return; // Return early as we handle save/update in timeout
                }
                saveData();
                updateStats();
            });

            document.getElementById('send-selected').addEventListener('click', () => {
                if (!state.selectedEmote) {
                    showToast('Select an emote from the palette first.', 'warning');
                    return;
                }
                const checked = Array.from(els.uidContainer.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => cb.closest('.uid-row').querySelector('input[type="number"]').value)
                    .filter(Boolean);
                
                if (checked.length === 0) {
                    showToast('Check at least one target with a valid UID.', 'warning');
                    return;
                }
                submitForm('emote', { emote_id: parseInt(state.selectedEmote.id), player_ids: checked.map(uid => parseInt(uid)) });
            });

            document.getElementById('send-all').addEventListener('click', () => {
                const payload = [];
                els.uidContainer.querySelectorAll('.uid-row').forEach(row => {
                    if (row.dataset.emoteId) {
                        const uid = row.querySelector('input[type="number"]').value;
                        if (uid) payload.push({ player_id: parseInt(uid), emote_id: parseInt(row.dataset.emoteId) });
                    }
                });
                if (payload.length === 0) {
                    showToast('No assigned emotes to send.', 'warning');
                    return;
                }
                submitForm('emote_batch', payload);
            });

            document.getElementById('join-squad').addEventListener('click', () => {
                if (!els.teamCode.value) {
                    showToast('Enter a team code first.', 'warning');
                    return;
                }
                submitForm('join_squad', { team_code: els.teamCode.value });
            });

            document.getElementById('quick-invite').addEventListener('click', () => {
                if (!els.mainUid.value) {
                    showToast('Enter your main account UID first.', 'warning');
                    return;
                }
                submitForm('quick_invite', { player_id: parseInt(els.mainUid.value) });
            });

            document.getElementById('leave-squad').addEventListener('click', () => {
                if (confirm('Are you sure you want the bot to leave its current squad?'))
                    submitForm('leave_squad', {});
            });

            loadData();

            // Improved Toast Notification System
            function showToast(message, type = 'success', duration = 4000) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                const icons = {
                    success: '<i class="fa-solid fa-circle-check"></i>',
                    danger: '<i class="fa-solid fa-circle-xmark"></i>',
                    warning: '<i class="fa-solid fa-triangle-exclamation"></i>',
                    info: '<i class="fa-solid fa-circle-info"></i>'
                };

                toast.innerHTML = `
                    <div class="toast-icon">${icons[type] || icons.success}</div>
                    <div class="toast-content">${message}</div>
                    <button class="toast-close"><i class="fa-solid fa-xmark"></i></button>
                    <div class="toast-progress"></div>
                `;

                container.appendChild(toast);

                const closeBtn = toast.querySelector('.toast-close');
                closeBtn.addEventListener('click', () => {
                    toast.classList.add('fade-out');
                    setTimeout(() => toast.remove(), 400);
                });

                setTimeout(() => {
                    toast.classList.add('fade-out');
                    setTimeout(() => toast.remove(), 400);
                }, duration);
            }

            // Flash Messages Handling
            if (window.flashMessages) {
                window.flashMessages.forEach(([category, message], index) => {
                    setTimeout(() => {
                        showToast(message, category);
                    }, index * 300);
                });
            }

            // Override alerts
            window.alert = function(message) {
                showToast(message, 'warning', 5000);
            };
        });
    </script>
</body>
</html>